generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL_POSTGRES")
}

model User {
  id        Int     @id @default(autoincrement())
  username  String  @unique
  name      String
  email     String
  password  String
  role      String
}

model Company {
  id               Int        @id @default(autoincrement())
  name             String
  pic_mitra        String?
  kontak_mitra     String?
  pic_partnership  String?
  logo_mitra_url   String?
  moms             Mom[]
  progress         Progress[]
  jiks             Jik[]
}

model Mom {
  id              Int          @id @default(autoincrement())
  company         Company      @relation(fields: [company_id], references: [id])
  company_id      Int
  title           String
  date            DateTime     @default(now())
  time            String?
  venue           String?
  count_attendees String?
  content         Json?        // simpan struktur rich text / array section TipTap

  mom_approvers   MomApprover[]
  attachments     MomAttachmentSection[] // relasi ke banyak file lampiran
  next_actions    NextAction[]

  progress        Progress?                @relation(fields: [progress_id], references: [id])
  progress_id     Int?

  created_at                DateTime @default(now())
  updated_at                DateTime @updatedAt
  deleted_at                DateTime?
}

model Approver {
  id        Int      @id @default(autoincrement())
  name      String
  type      String?   // internal / external
  email     String?
  jabatan   String?   // kalau internal
  nik       String?   // kalau internal

  createdAt DateTime  @default(now())
  updatedAt DateTime  @updatedAt

  // relasi ke jik / MoM
  momApprovers MomApprover[]
  jikApprovers JikApprover[]
}

model MomApprover {
  id           Int        @id @default(autoincrement())
  mom_id       Int
  approver_id  Int
  is_approved  Boolean    @default(false)

  // tokenization
  verify_token String?    @unique
  expires_at   DateTime?

  approver     Approver   @relation(fields: [approver_id], references: [id])
  mom          Mom        @relation(fields: [mom_id], references: [id])

  createdAt    DateTime   @default(now())
  updatedAt    DateTime   @updatedAt
}

model MomAttachmentSection {
  id          Int                    @id @default(autoincrement())
  mom_id      Int
  section_name String                 // nama section, misal "Lampiran Teknis" atau "Foto Dokumentasi"
  created_at  DateTime               @default(now())

  mom         Mom                    @relation(fields: [mom_id], references: [id])
  files       MomAttachmentFile[]    // relasi ke file di section ini
}

model MomAttachmentFile {
  id              Int      @id @default(autoincrement())
  section_id      Int
  file_name       String
  url             String   // path atau link ke storage
  uploaded_at     DateTime @default(now())

  section         MomAttachmentSection @relation(fields: [section_id], references: [id])
}


model NextAction {
  id        Int      @id @default(autoincrement())
  mom_id    Int
  action    String
  target    String
  pic       String
  created_at DateTime @default(now())

  mom       Mom      @relation(fields: [mom_id], references: [id])
}

model JikApprover {
  id           Int        @id @default(autoincrement())
  jik_id       Int
  approver_id  Int
  approver_type String?

  jik          Jik        @relation(fields: [jik_id], references: [id])
  approver     Approver   @relation(fields: [approver_id], references: [id])

  createdAt    DateTime   @default(now())
  updatedAt    DateTime   @updatedAt
}

model Jik {
  id                        Int      @id @default(autoincrement())
  company                   Company  @relation(fields: [company_id], references: [id])
  company_id                Int
  judul                     String
  no                        String?
  nama                      String?
  nama_unit                 String?
  initiative_partnership    String?
  invest_value              String?
  contract_duration_years   Int?
  
  document_initiative       Json?

  progress                  Progress? @relation(fields: [progress_id], references: [id])
  progress_id               Int?

  jik_approvers             JikApprover[]

  created_at                DateTime @default(now())
  updated_at                DateTime @updatedAt
  deleted_at                DateTime?
}

model Progress {
  id          Int        @id @default(autoincrement())
  company     Company    @relation(fields: [company_id], references: [id])
  company_id  Int
  step        Step?      @relation(fields: [step_id], references: [id])
  step_id     Int?
  status      Status?    @relation(fields: [status_id], references: [id])
  status_id   Int?
  documents   Document[]

  moms        Mom[]
  jiks         Jik[]
}

model Step {
  id        Int        @id @default(autoincrement())
  name      String
  progress  Progress[]
}

model Status {
  id        Int        @id @default(autoincrement())
  name      String
  progress  Progress[]
}

model Document {
  id           Int        @id @default(autoincrement())
  progress     Progress   @relation(fields: [progress_id], references: [id])
  progress_id  Int        @unique
  document_url String?

  created_at                DateTime @default(now())
  updated_at                DateTime @updatedAt
  deleted_at                DateTime?
}

model Chat {
  id          Int           @id @default(autoincrement())
  uuid        String        @unique
  title       String
  histories   ChatHistory[] // relasi 1-n
  createdAt   DateTime      @default(now())
  updatedAt   DateTime      @updatedAt
}

model ChatHistory {
  id        Int      @id @default(autoincrement())
  chatId    Int
  question  String
  answer    String?
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  chat Chat @relation(fields: [chatId], references: [id])
}
